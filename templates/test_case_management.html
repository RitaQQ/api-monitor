{% extends "base.html" %}

{% block title %}測試案例管理 - API Monitor{% endblock %}
{% block page_title %}測試案例管理{% endblock %}
{% block page_subtitle %}管理和追蹤產品測試案例{% endblock %}

{% block extra_css %}
.test-case-card {
    background: #161B22;
    border: 1px solid #30363D;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    transition: transform 0.2s, border-color 0.2s;
}

.test-case-card:hover {
    transform: translateY(-2px);
    border-color: #58a6ff;
}

.test-case-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.test-case-title {
    color: #C9D1D9;
    font-size: 1.2em;
    font-weight: 600;
    margin: 0;
}

.test-case-id {
    font-size: 0.8em;
    color: #8B949E;
    font-family: 'Courier New', monospace;
    margin-top: 5px;
}

.test-case-meta {
    color: #8B949E;
    margin-bottom: 15px;
}

.user-role {
    background: rgba(88, 166, 255, 0.2);
    color: #58a6ff;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 8px;
}

.feature-description {
    color: #C9D1D9;
    margin-bottom: 15px;
    padding: 12px;
    background: #0D1117;
    border-radius: 6px;
    border-left: 3px solid #58a6ff;
}

.acceptance-criteria {
    margin-bottom: 15px;
}

.criteria-title {
    color: #C9D1D9;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.criteria-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.criteria-item {
    padding: 4px 0;
    padding-left: 20px;
    position: relative;
    color: #C9D1D9;
    font-size: 0.85em;
}

.criteria-item:before {
    content: "✓";
    position: absolute;
    left: 0;
    color: #238636;
    font-weight: bold;
}

.test-notes {
    background: #0D1117;
    border: 1px solid #30363D;
    border-radius: 6px;
    padding: 10px;
    color: #8B949E;
    font-size: 0.85em;
    margin-bottom: 15px;
}

.product-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 15px;
}

.tag-badge {
    background: #30363D;
    color: #8B949E;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 500;
}

.test-case-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    border-top: 1px solid #30363D;
    padding-top: 15px;
}

.test-case-actions .btn {
    font-size: 0.85em;
    padding: 6px 12px;
}

.create-test-case-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #238636;
    border: none;
    color: white;
    font-size: 1.5em;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
    transition: all 0.2s;
}

.create-test-case-btn:hover {
    background: #2ea043;
    transform: scale(1.1);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #8B949E;
}

.empty-icon {
    font-size: 4em;
    margin-bottom: 20px;
    color: #30363D;
}

.search-controls {
    background: #161B22;
    border: 1px solid #30363D;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.search-input, .filter-select {
    background: #0D1117;
    color: #C9D1D9;
    border: 1px solid #30363D;
    border-radius: 6px;
    padding: 10px 15px;
}

.search-input:focus, .filter-select:focus {
    border-color: #58a6ff;
    box-shadow: 0 0 0 0.2rem rgba(88, 166, 255, 0.25);
    outline: none;
    background: #0D1117;
    color: #C9D1D9;
}


.bulk-actions {
    background: #0D1117;
    border: 1px solid #30363D;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: none;
}

.bulk-actions.active {
    display: block;
}

.test-case-checkbox {
    margin-right: 10px;
}

.selected-count {
    color: #58a6ff;
    font-weight: bold;
}

.test-cases-table {
    background: #161B22;
    border: 1px solid #30363D;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
}

.test-cases-table table {
    width: 100%;
    margin: 0;
    border-collapse: collapse;
}

.test-cases-table th {
    background: #0D1117;
    color: #C9D1D9;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid #30363D;
    font-size: 0.9em;
}

.test-cases-table td {
    padding: 15px 12px;
    border-bottom: 1px solid #30363D;
    vertical-align: top;
}

.test-cases-table tbody tr {
    transition: background-color 0.2s;
}

.test-cases-table tbody tr:hover {
    background-color: #0D1117;
}

.test-cases-table tbody tr:last-child td {
    border-bottom: none;
}

.test-case-title-cell {
    font-weight: 600;
    color: #C9D1D9;
    max-width: 250px;
}

.test-case-id-cell {
    font-family: 'Courier New', monospace;
    color: #8B949E;
    font-size: 0.85em;
    width: 100px;
}

.test-case-description-cell {
    color: #C9D1D9;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.test-case-tags-cell {
    max-width: 200px;
}

.test-case-actions-cell {
    width: 120px;
    text-align: right;
}

.table-tag-badge {
    background: #30363D;
    color: #8B949E;
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 0.7em;
    font-weight: 500;
    margin-right: 4px;
    margin-bottom: 2px;
    display: inline-block;
}

.test-case-criteria-cell {
    color: #C9D1D9;
    max-width: 250px;
    font-size: 0.85em;
}

.criteria-item {
    margin-bottom: 4px;
    color: #C9D1D9;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.table-checkbox {
    margin: 0;
}
{% endblock %}

{% block content %}
<!-- 搜尋和過濾控制 -->
<div class="search-controls">
    <div class="row align-items-center">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text" style="background: #0D1117; border-color: #30363D; color: #8B949E;">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control search-input" id="searchInput" 
                       placeholder="搜尋測試案例..." onkeyup="filterTestCases()">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select filter-select" id="tagFilter" onchange="filterTestCases()">
                <option value="">所有標籤</option>
                <!-- 標籤選項將通過 JavaScript 載入 -->
            </select>
        </div>
        <div class="col-md-5 text-end">
            <button class="btn btn-outline-secondary btn-sm me-2" onclick="toggleSelectAll()">
                <i class="fas fa-check-square"></i> 全選/取消
            </button>
            <button class="btn btn-outline-success btn-sm me-2" onclick="showImportModal()">
                <i class="fas fa-upload"></i> 匯入
            </button>
            <button class="btn btn-outline-primary btn-sm me-2" onclick="exportTestCases()">
                <i class="fas fa-download"></i> 匯出
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="loadTestCases(true)">
                <i class="fas fa-sync-alt"></i> 重新載入
            </button>
        </div>
    </div>
</div>


<!-- 批量操作 -->
<div class="bulk-actions" id="bulkActions">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <span class="selected-count" id="selectedCount">已選擇 0 個測試案例</span>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-warning me-2" onclick="bulkEdit()">
                <i class="fas fa-edit"></i> 批量編輯
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">
                <i class="fas fa-trash"></i> 批量刪除
            </button>
        </div>
    </div>
</div>

<!-- 測試案例列表 -->
<div class="test-cases-table" id="testCasesTableContainer">
    <div class="d-flex justify-content-between align-items-center" style="padding: 15px 15px 0 15px;">
        <div></div>
        <small class="text-muted" id="testCaseCount" style="color: #8B949E; font-size: 0.8em;">
            <!-- 總數顯示 -->
        </small>
    </div>
    <table>
        <thead>
            <tr>
                <th width="40">
                    <input type="checkbox" class="table-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                </th>
                <th width="100">測項ID</th>
                <th>標題</th>
                <th>功能描述</th>
                <th width="200">驗收條件</th>
                <th width="150">產品標籤</th>
                <th width="120">操作</th>
            </tr>
        </thead>
        <tbody id="testCasesContainer">
            <!-- 測試案例將通過 JavaScript 載入 -->
        </tbody>
    </table>
</div>

<!-- 載入中提示 -->
<div id="loadingIndicator" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-3" style="color: #8B949E;">載入測試案例中...</p>
</div>

<!-- 空狀態 -->
<div id="emptyState" class="empty-state" style="display: none;">
    <div class="empty-icon">
        <i class="fas fa-list-check"></i>
    </div>
    <h4>尚無測試案例</h4>
    <p>點擊右下角的按鈕建立您的第一個測試案例</p>
</div>

<!-- 新增測試案例按鈕 -->
<button class="create-test-case-btn" onclick="showCreateTestCaseModal()" title="新增測試案例">
    <i class="fas fa-plus"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
let allTestCases = [];
let availableProductTags = [];
let selectedTestCases = new Set();

// 頁面載入完成時初始化
document.addEventListener('DOMContentLoaded', function() {
    loadTestCases();
    loadProductTags();
});

// 載入測試案例
async function loadTestCases(showLoading = false) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const testCasesContainer = document.getElementById('testCasesContainer');
    const emptyState = document.getElementById('emptyState');
    
    try {
        if (showLoading) {
            loadingIndicator.style.display = 'block';
            emptyState.style.display = 'none';
        }
        
        const response = await fetch('/api/test-cases');
        if (!response.ok) throw new Error('載入測試案例失敗');
        
        allTestCases = await response.json();
        
        if (allTestCases.length === 0) {
            emptyState.style.display = 'block';
            testCasesContainer.innerHTML = '';
        } else {
            renderTestCases(allTestCases);
            updateTestCaseCount(allTestCases.length);
        }
        
    } catch (error) {
        console.error('載入測試案例失敗:', error);
        testCasesContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> 載入測試案例失敗
                </div>
            </div>
        `;
    } finally {
        if (showLoading) {
            loadingIndicator.style.display = 'none';
        }
    }
}

// 載入產品標籤
async function loadProductTags() {
    try {
        const response = await fetch('/api/product-tags');
        if (response.ok) {
            availableProductTags = await response.json();
            updateTagFilter();
        }
    } catch (error) {
        console.error('載入產品標籤失敗:', error);
    }
}

// 更新標籤篩選器
function updateTagFilter() {
    const tagFilter = document.getElementById('tagFilter');
    tagFilter.innerHTML = '<option value="">所有標籤</option>';
    
    availableProductTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag.id;
        option.textContent = tag.name; // 只顯示名稱，不顯示ID
        tagFilter.appendChild(option);
    });
}

// 生成TC格式的顯示ID
function generateTCId(index) {
    return `TC${String(index + 1).padStart(5, '0')}`;
}

// 渲染測試案例
function renderTestCases(testCases) {
    const testCasesContainer = document.getElementById('testCasesContainer');
    
    testCasesContainer.innerHTML = testCases.map((testCase, index) => {
        const tagNames = (testCase.product_tags || []).map(tagId => {
            const tag = availableProductTags.find(t => t.id == tagId); // 使用 == 比較，支援字串和數字
            return tag ? tag.name : '';
        }).filter(name => name); // 過濾掉空字串，只顯示標籤名稱
        
        const tcId = generateTCId(index);
        
        return `
            <tr data-test-case-id="${testCase.id}">
                <td>
                    <input type="checkbox" class="table-checkbox test-case-checkbox" value="${testCase.id}" 
                           onchange="handleTestCaseSelection()">
                </td>
                <td class="test-case-id-cell">${tcId}</td>
                <td class="test-case-title-cell">${testCase.title}</td>
                <td class="test-case-description-cell">${testCase.feature_description}</td>
                <td class="test-case-criteria-cell">
                    ${testCase.acceptance_criteria && testCase.acceptance_criteria.length > 0 ? 
                        testCase.acceptance_criteria.map(criterion => 
                            `<div class="criteria-item">• ${criterion}</div>`
                        ).join('') : 
                        '<span style="color: #8B949E;">無驗收條件</span>'
                    }
                </td>
                <td class="test-case-tags-cell">
                    ${tagNames.length > 0 ? 
                        tagNames.map(tagName => 
                            `<span class="table-tag-badge">${tagName}</span>`
                        ).join('') : 
                        '<span style="color: #8B949E;">無標籤</span>'
                    }
                </td>
                <td class="test-case-actions-cell">
                    <button class="btn btn-sm btn-outline-warning me-1" 
                            onclick="editTestCase('${testCase.id}')" title="編輯">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteTestCase('${testCase.id}', '${testCase.title}')" title="刪除">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// 更新測試案例總數顯示
function updateTestCaseCount(count) {
    const testCaseCount = document.getElementById('testCaseCount');
    testCaseCount.textContent = `共 ${count} 項測試案例`;
}

// 過濾測試案例
function filterTestCases() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const selectedTagId = document.getElementById('tagFilter').value;
    const testCaseRows = document.querySelectorAll('[data-test-case-id]');
    
    let visibleCount = 0;
    testCaseRows.forEach(row => {
        const testCaseId = row.dataset.testCaseId;
        const testCase = allTestCases.find(tc => tc.id === testCaseId);
        
        if (!testCase) return;
        
        // 文字搜尋
        const titleMatch = testCase.title.toLowerCase().includes(searchTerm);
        const descriptionMatch = testCase.feature_description.toLowerCase().includes(searchTerm);
        const roleMatch = testCase.user_role.toLowerCase().includes(searchTerm);
        const textMatch = titleMatch || descriptionMatch || roleMatch;
        
        // 標籤篩選
        const tagMatch = !selectedTagId || testCase.product_tags.includes(parseInt(selectedTagId)) || testCase.product_tags.includes(selectedTagId);
        
        const shouldShow = textMatch && tagMatch;
        row.style.display = shouldShow ? '' : 'none';
        
        if (shouldShow) visibleCount++;
    });
    
    // 更新空狀態顯示
    const emptyState = document.getElementById('emptyState');
    const tableContainer = document.getElementById('testCasesTableContainer');
    
    if (visibleCount === 0 && allTestCases.length > 0) {
        tableContainer.style.display = 'none';
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div class="empty-icon">
                <i class="fas fa-search"></i>
            </div>
            <h4>找不到符合條件的測試案例</h4>
            <p>請嘗試調整搜尋條件</p>
        `;
    } else if (allTestCases.length === 0) {
        tableContainer.style.display = 'none';
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div class="empty-icon">
                <i class="fas fa-list-check"></i>
            </div>
            <h4>尚無測試案例</h4>
            <p>點擊右下角的按鈕建立您的第一個測試案例</p>
        `;
    } else {
        tableContainer.style.display = 'block';
        emptyState.style.display = 'none';
    }
    
    // 更新總數顯示
    updateTestCaseCount(visibleCount);
}

// 處理測試案例選擇
function handleTestCaseSelection() {
    const checkboxes = document.querySelectorAll('.test-case-checkbox');
    selectedTestCases.clear();
    
    checkboxes.forEach(cb => {
        if (cb.checked) {
            selectedTestCases.add(cb.value);
        }
    });
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedTestCases.size > 0) {
        bulkActions.classList.add('active');
        selectedCount.textContent = `已選擇 ${selectedTestCases.size} 個測試案例`;
    } else {
        bulkActions.classList.remove('active');
    }
}

// 全選/取消全選
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const visibleCheckboxes = document.querySelectorAll('.test-case-checkbox');
    const visibleRows = Array.from(visibleCheckboxes).filter(cb => 
        cb.closest('tr').style.display !== 'none'
    );
    
    const shouldCheck = selectAllCheckbox.checked;
    
    visibleRows.forEach(cb => {
        cb.checked = shouldCheck;
    });
    
    handleTestCaseSelection();
}

// 顯示新增測試案例模態框
function showCreateTestCaseModal() {
    showTestCaseModal();
}

// 編輯測試案例
function editTestCase(testCaseId) {
    console.log('編輯測試案例:', testCaseId);
    const testCase = allTestCases.find(tc => tc.id == testCaseId); // 使用 == 比較，支援字串和數字
    console.log('找到的測試案例:', testCase);
    if (testCase) {
        showTestCaseModal(testCase);
    } else {
        console.error('找不到測試案例:', testCaseId);
        showAlert('找不到指定的測試案例', 'error');
    }
}

// 顯示測試案例模態框
function showTestCaseModal(testCase = null) {
    console.log('顯示模態框，測試案例:', testCase);
    const isEdit = testCase !== null;
    const modalTitle = isEdit ? '編輯測試案例' : '新增測試案例';
    
    // 安全地獲取欄位值
    const title = testCase ? (testCase.title || '') : '';
    const userRole = testCase ? (testCase.user_role || '') : '';
    const featureDescription = testCase ? (testCase.feature_description || '') : '';
    const testNotes = testCase ? (testCase.test_notes || '') : '';
    
    // 安全地處理驗收條件
    let acceptanceCriteriaText = '';
    if (testCase && testCase.acceptance_criteria) {
        if (Array.isArray(testCase.acceptance_criteria)) {
            acceptanceCriteriaText = testCase.acceptance_criteria.join('\n');
        } else if (typeof testCase.acceptance_criteria === 'string') {
            acceptanceCriteriaText = testCase.acceptance_criteria;
        }
    }
    
    const modalHtml = `
        <div class="modal fade" id="testCaseModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background: #161B22; color: #C9D1D9; border: 1px solid #30363D;">
                    <div class="modal-header" style="background: #0D1117; border-bottom: 1px solid #30363D;">
                        <h5 class="modal-title" style="color: #C9D1D9;">${modalTitle}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="testCaseForm">
                            <div class="mb-3">
                                <label class="form-label" style="color: #C9D1D9;">標題 *</label>
                                <input type="text" class="form-control" id="testCaseTitle" 
                                       value="${title}" required
                                       style="background: #161B22; color: #C9D1D9; border: 1px solid #30363D;">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" style="color: #C9D1D9;">功能描述 *</label>
                                <textarea class="form-control" id="featureDescription" rows="3" required
                                          style="background: #161B22; color: #C9D1D9; border: 1px solid #30363D;"
                                          placeholder="描述這個測試項目的功能...">${featureDescription}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" style="color: #C9D1D9;">用戶角色 *</label>
                                <input type="text" class="form-control" id="userRole" 
                                       value="${userRole}" required
                                       style="background: #161B22; color: #C9D1D9; border: 1px solid #30363D;"
                                       placeholder="例如：一般用戶、管理者、訪客">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" style="color: #C9D1D9;">驗收條件</label>
                                <textarea class="form-control" id="acceptanceCriteria" rows="4"
                                          style="background: #161B22; color: #C9D1D9; border: 1px solid #30363D;"
                                          placeholder="每行一個驗收條件，例如：&#10;能夠成功登入系統&#10;顯示正確的用戶資訊&#10;登入失敗時顯示錯誤訊息">${acceptanceCriteriaText}</textarea>
                                <div class="form-text" style="color: #8B949E;">每行一個驗收條件，列出此功能需要滿足的具體要求</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" style="color: #C9D1D9;">測試備註</label>
                                <textarea class="form-control" id="testNotes" rows="2"
                                          style="background: #161B22; color: #C9D1D9; border: 1px solid #30363D;"
                                          placeholder="測試相關的備註資訊">${testNotes}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" style="color: #C9D1D9;">產品標籤</label>
                                <div class="row">
                                    ${availableProductTags.map(tag => {
                                        const isChecked = testCase && testCase.product_tags && 
                                            (testCase.product_tags.includes(tag.id) || testCase.product_tags.includes(String(tag.id)));
                                        return `
                                        <div class="col-md-6 mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input tag-checkbox" type="checkbox" 
                                                       value="${tag.id}" id="tag_${tag.id}"
                                                       ${isChecked ? 'checked' : ''}>
                                                <label class="form-check-label" for="tag_${tag.id}" style="color: #C9D1D9;">
                                                    ${tag.name}
                                                </label>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #30363D;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-success" onclick="saveTestCase(${isEdit ? `'${testCase.id}'` : 'null'})">
                            ${isEdit ? '更新' : '建立'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    try {
        // 移除舊的模態框
        const existingModal = document.getElementById('testCaseModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // 添加新的模態框
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // 顯示模態框
        const modal = new bootstrap.Modal(document.getElementById('testCaseModal'));
        modal.show();
        
        console.log('模態框顯示成功');
    } catch (error) {
        console.error('顯示模態框時發生錯誤:', error);
        showAlert('無法顯示編輯窗口，請重新整理頁面後再試', 'error');
    }
}

// 這些函數已不再需要，因為驗收條件已隱藏

// 保存測試案例
async function saveTestCase(testCaseId = null) {
    const isEdit = testCaseId !== null;
    
    // 收集表單資料
    const formData = {
        title: document.getElementById('testCaseTitle').value.trim(),
        user_role: document.getElementById('userRole').value.trim(),
        feature_description: document.getElementById('featureDescription').value.trim(),
        test_notes: document.getElementById('testNotes').value.trim() || null
    };
    
    // 收集驗收條件（從 textarea 轉換為陣列）
    const criteriaText = document.getElementById('acceptanceCriteria').value.trim();
    formData.acceptance_criteria = criteriaText ? 
        criteriaText.split('\n').map(line => line.trim()).filter(line => line) : [];
    
    // 收集產品標籤
    const tagCheckboxes = document.querySelectorAll('.tag-checkbox:checked');
    formData.product_tags = Array.from(tagCheckboxes).map(cb => cb.value);
    
    // 驗證
    if (!formData.title || !formData.user_role || !formData.feature_description) {
        showAlert('請填寫所有必填欄位', 'danger');
        return;
    }
    
    try {
        const url = isEdit ? `/api/test-cases/${testCaseId}` : '/api/test-cases';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            // 關閉模態框
            const modal = bootstrap.Modal.getInstance(document.getElementById('testCaseModal'));
            modal.hide();
            
            // 重新載入測試案例列表
            await loadTestCases();
            
            // 顯示成功訊息
            showAlert(isEdit ? '測試案例更新成功！' : '測試案例建立成功！', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || '保存失敗');
        }
    } catch (error) {
        console.error('保存測試案例失敗:', error);
        showAlert('保存失敗: ' + error.message, 'danger');
    }
}

// 刪除測試案例
async function deleteTestCase(testCaseId, testCaseTitle) {
    if (!confirm(`確定要刪除測試案例「${testCaseTitle}」嗎？\n\n此操作無法復原！`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/test-cases/${testCaseId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // 重新載入測試案例列表
            await loadTestCases();
            showAlert('測試案例刪除成功', 'success');
        } else {
            const error = await response.json();
            throw new Error(error.error || '刪除失敗');
        }
    } catch (error) {
        console.error('刪除測試案例失敗:', error);
        showAlert('刪除失敗: ' + error.message, 'danger');
    }
}

// 批量操作
function bulkEdit() {
    showAlert('批量編輯功能開發中...', 'info');
}

function bulkDelete() {
    if (selectedTestCases.size === 0) return;
    
    if (!confirm(`確定要刪除 ${selectedTestCases.size} 個測試案例嗎？\n\n此操作無法復原！`)) {
        return;
    }
    
    // 實作批量刪除邏輯
    showAlert('批量刪除功能開發中...', 'info');
}

// 顯示匯入模態框
function showImportModal() {
    const modalHtml = `
        <div class="modal fade" id="importModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content" style="background: #161B22; color: #C9D1D9; border: 1px solid #30363D;">
                    <div class="modal-header" style="background: #0D1117; border-bottom: 1px solid #30363D;">
                        <h5 class="modal-title" style="color: #C9D1D9;">
                            <i class="fas fa-upload"></i> 匯入測試案例
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label" style="color: #C9D1D9;">選擇CSV檔案</label>
                            <input type="file" class="form-control" id="csvFileInput" accept=".csv"
                                   style="background: #161B22; color: #C9D1D9; border: 1px solid #30363D;">
                            <div class="form-text" style="color: #8B949E;">
                                請選擇CSV格式的測試案例檔案
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6 style="color: #C9D1D9; margin-bottom: 10px;">CSV格式要求：</h6>
                            <div style="background: #0D1117; padding: 12px; border-radius: 6px; font-size: 0.85em; color: #8B949E;">
                                <div><strong style="color: #C9D1D9;">必要欄位（按順序）：</strong></div>
                                <div>1. 標題</div>
                                <div>2. 用戶角色</div>
                                <div>3. 功能描述</div>
                                <div><br><strong style="color: #C9D1D9;">選用欄位：</strong></div>
                                <div>4. 驗收條件（用分號分隔）</div>
                                <div>5. 測試備註</div>
                                <div>6. 產品標籤（用逗號分隔標籤名稱）</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="downloadTemplate()">
                                <i class="fas fa-download"></i> 下載範本檔案
                            </button>
                        </div>
                        
                        <!-- 進度顯示 -->
                        <div id="importProgress" style="display: none;">
                            <div class="mb-2">
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar" id="importProgressBar" role="progressbar" 
                                         style="width: 0%; background-color: #238636;"></div>
                                </div>
                            </div>
                            <div id="importStatus" style="color: #8B949E; font-size: 0.85em;">準備匯入...</div>
                        </div>
                        
                        <!-- 結果顯示 -->
                        <div id="importResults" style="display: none; margin-top: 15px;">
                            <div id="importSummary" class="mb-2"></div>
                            <div id="importErrors" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #30363D;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-success" onclick="startImport()">
                            <i class="fas fa-upload"></i> 開始匯入
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除舊的模態框
    const existingModal = document.getElementById('importModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新的模態框
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

// 下載CSV範本檔案
function downloadTemplate() {
    const templateHeaders = [
        '標題',
        '用戶角色',
        '功能描述',
        '驗收條件',
        '測試備註',
        '產品標籤'
    ];
    
    const templateData = [
        [
            '登入功能測試',
            '一般用戶',
            '我希望能夠使用帳號密碼登入系統',
            '輸入正確帳密可成功登入; 錯誤帳密顯示錯誤訊息; 登入後導向首頁',
            '需測試各種瀏覽器',
            'web, app'
        ],
        [
            '購物車功能測試',
            '購物用戶',
            '我希望能夠將商品加入購物車',
            '點擊加入購物車按鈕; 購物車數量增加; 商品出現在購物車列表',
            '',
            'web'
        ]
    ];
    
    const allRows = [templateHeaders, ...templateData];
    const csvContent = allRows.map(row => 
        row.map(field => {
            const fieldStr = String(field);
            if (fieldStr.includes(',') || fieldStr.includes('\n') || fieldStr.includes('"')) {
                return '"' + fieldStr.replace(/"/g, '""') + '"';
            }
            return fieldStr;
        }).join(',')
    ).join('\n');
    
    // 添加BOM以支援中文
    const bom = '\uFEFF';
    const csvWithBom = bom + csvContent;
    
    const blob = new Blob([csvWithBom], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', '測試案例匯入範本.csv');
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('範本檔案下載完成', 'success');
}

// 開始匯入流程
async function startImport() {
    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('請選擇CSV檔案', 'warning');
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.csv')) {
        showAlert('請選擇CSV格式檔案', 'warning');
        return;
    }
    
    // 顯示進度條
    document.getElementById('importProgress').style.display = 'block';
    document.getElementById('importResults').style.display = 'none';
    
    updateImportProgress(0, '讀取檔案中...');
    
    try {
        // 讀取檔案內容
        const csvContent = await readFileAsText(file);
        updateImportProgress(20, '解析CSV格式...');
        
        // 解析CSV
        const parsedData = parseCSV(csvContent);
        updateImportProgress(40, '驗證數據格式...');
        
        // 驗證數據
        const validationResult = validateImportData(parsedData);
        updateImportProgress(60, '準備建立測試案例...');
        
        if (validationResult.errors.length > 0) {
            showImportResults(0, validationResult.errors.length, validationResult.errors);
            return;
        }
        
        // 批量建立測試案例
        const importResult = await batchCreateTestCases(validationResult.validData);
        updateImportProgress(100, '匯入完成');
        
        // 顯示結果
        showImportResults(importResult.success, importResult.failed, importResult.errors);
        
        // 重新載入測試案例列表
        if (importResult.success > 0) {
            await loadTestCases();
        }
        
    } catch (error) {
        console.error('匯入失敗:', error);
        showImportResults(0, 1, [`匯入失敗: ${error.message}`]);
    }
}

// 讀取檔案為文字
function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(new Error('檔案讀取失敗'));
        reader.readAsText(file, 'UTF-8');
    });
}

// 解析CSV內容
function parseCSV(csvContent) {
    const lines = csvContent.split('\n').filter(line => line.trim());
    const result = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const row = parseCSVLine(line);
        result.push({
            lineNumber: i + 1,
            data: row
        });
    }
    
    return result;
}

// 解析單行CSV（處理引號和逗號）
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    let i = 0;
    
    while (i < line.length) {
        const char = line[i];
        
        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                // 雙引號轉義
                current += '"';
                i += 2;
            } else {
                // 切換引號狀態
                inQuotes = !inQuotes;
                i++;
            }
        } else if (char === ',' && !inQuotes) {
            // 欄位分隔符
            result.push(current.trim());
            current = '';
            i++;
        } else {
            current += char;
            i++;
        }
    }
    
    // 添加最後一個欄位
    result.push(current.trim());
    
    return result;
}

// 驗證匯入數據
function validateImportData(parsedData) {
    const validData = [];
    const errors = [];
    
    // 跳過標題行（如果存在）
    let startIndex = 0;
    if (parsedData.length > 0) {
        const firstRow = parsedData[0].data;
        if (firstRow[0] === '標題' || firstRow[0] === 'title') {
            startIndex = 1;
        }
    }
    
    for (let i = startIndex; i < parsedData.length; i++) {
        const row = parsedData[i];
        const data = row.data;
        
        // 檢查必要欄位
        if (data.length < 3) {
            errors.push(`第 ${row.lineNumber} 行：缺少必要欄位（至少需要標題、用戶角色、功能描述）`);
            continue;
        }
        
        const title = data[0]?.trim();
        const userRole = data[1]?.trim();
        const featureDescription = data[2]?.trim();
        
        if (!title) {
            errors.push(`第 ${row.lineNumber} 行：標題不能為空`);
            continue;
        }
        
        if (!userRole) {
            errors.push(`第 ${row.lineNumber} 行：用戶角色不能為空`);
            continue;
        }
        
        if (!featureDescription) {
            errors.push(`第 ${row.lineNumber} 行：功能描述不能為空`);
            continue;
        }
        
        // 處理選用欄位
        const acceptanceCriteria = data[3] ? data[3].split(';').map(c => c.trim()).filter(c => c) : [];
        const testNotes = data[4]?.trim() || null;
        const productTagNames = data[5] ? data[5].split(',').map(t => t.trim()).filter(t => t) : [];
        
        // 轉換產品標籤名稱為ID
        const productTags = productTagNames.map(tagName => {
            const tag = availableProductTags.find(t => t.name === tagName);
            return tag ? tag.id : null;
        }).filter(id => id);
        
        // 檢查無效的產品標籤
        const invalidTags = productTagNames.filter(tagName => 
            !availableProductTags.find(t => t.name === tagName)
        );
        
        if (invalidTags.length > 0) {
            errors.push(`第 ${row.lineNumber} 行：無效的產品標籤：${invalidTags.join(', ')}`);
        }
        
        validData.push({
            title,
            user_role: userRole,
            feature_description: featureDescription,
            acceptance_criteria: acceptanceCriteria,
            test_notes: testNotes,
            product_tags: productTags,
            lineNumber: row.lineNumber
        });
    }
    
    return { validData, errors };
}

// 批量建立測試案例
async function batchCreateTestCases(testCases) {
    const result = { success: 0, failed: 0, errors: [] };
    const total = testCases.length;
    
    for (let i = 0; i < testCases.length; i++) {
        const testCase = testCases[i];
        
        try {
            updateImportProgress(
                60 + (i / total) * 35, 
                `建立測試案例 ${i + 1}/${total}...`
            );
            
            const response = await fetch('/api/test-cases', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: testCase.title,
                    user_role: testCase.user_role,
                    feature_description: testCase.feature_description,
                    acceptance_criteria: testCase.acceptance_criteria,
                    test_notes: testCase.test_notes,
                    product_tags: testCase.product_tags
                })
            });
            
            if (response.ok) {
                result.success++;
            } else {
                const error = await response.json();
                result.failed++;
                result.errors.push(`第 ${testCase.lineNumber} 行：${error.error || '建立失敗'}`);
            }
            
        } catch (error) {
            result.failed++;
            result.errors.push(`第 ${testCase.lineNumber} 行：${error.message}`);
        }
    }
    
    return result;
}

// 更新匯入進度
function updateImportProgress(percentage, status) {
    const progressBar = document.getElementById('importProgressBar');
    const statusText = document.getElementById('importStatus');
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
    }
    
    if (statusText) {
        statusText.textContent = status;
    }
}

// 顯示匯入結果
function showImportResults(successCount, errorCount, errors) {
    const importResults = document.getElementById('importResults');
    const importSummary = document.getElementById('importSummary');
    const importErrors = document.getElementById('importErrors');
    
    importResults.style.display = 'block';
    
    // 顯示摘要
    let summaryHtml = '';
    if (successCount > 0) {
        summaryHtml += `<span style="color: #238636;"><i class="fas fa-check-circle"></i> 成功匯入 ${successCount} 個測試案例</span>`;
    }
    if (errorCount > 0) {
        if (summaryHtml) summaryHtml += '<br>';
        summaryHtml += `<span style="color: #f85149;"><i class="fas fa-exclamation-circle"></i> ${errorCount} 個錯誤</span>`;
    }
    
    importSummary.innerHTML = summaryHtml;
    
    // 顯示錯誤詳情
    if (errors.length > 0) {
        const errorsHtml = errors.map(error => 
            `<div style="color: #f85149; font-size: 0.85em; margin-bottom: 4px;">• ${error}</div>`
        ).join('');
        importErrors.innerHTML = `<div style="color: #C9D1D9; font-weight: 600; margin-bottom: 8px;">錯誤詳情：</div>${errorsHtml}`;
    } else {
        importErrors.innerHTML = '';
    }
}

// 匯出測試案例為CSV
function exportTestCases() {
    if (allTestCases.length === 0) {
        showAlert('沒有測試案例可匯出', 'warning');
        return;
    }
    
    try {
        // 準備CSV標題行
        const headers = [
            '測項ID',
            '標題',
            '用戶角色', 
            '功能描述',
            '驗收條件',
            '測試備註',
            '產品標籤',
            '建立時間',
            '更新時間'
        ];
        
        // 準備CSV數據行
        const csvData = allTestCases.map((testCase, index) => {
            // 生成TC格式ID
            const tcId = generateTCId(index);
            
            // 處理產品標籤名稱轉換
            const tagNames = testCase.product_tags.map(tagId => {
                const tag = availableProductTags.find(t => t.id === tagId);
                return tag ? tag.name : '';
            }).filter(name => name).join(', ');
            
            // 處理驗收條件（陣列轉字串）
            const acceptanceCriteria = Array.isArray(testCase.acceptance_criteria) 
                ? testCase.acceptance_criteria.join('; ') 
                : '';
            
            // 處理時間格式
            const createdAt = testCase.created_at ? new Date(testCase.created_at).toLocaleString('zh-TW') : '';
            const updatedAt = testCase.updated_at ? new Date(testCase.updated_at).toLocaleString('zh-TW') : '';
            
            return [
                tcId,
                testCase.title || '',
                testCase.user_role || '',
                testCase.feature_description || '',
                acceptanceCriteria,
                testCase.test_notes || '',
                tagNames,
                createdAt,
                updatedAt
            ];
        });
        
        // 組合完整的CSV數據
        const allRows = [headers, ...csvData];
        
        // 轉換為CSV格式
        const csvContent = allRows.map(row => 
            row.map(field => {
                // 處理包含逗號、換行或雙引號的字段
                const fieldStr = String(field);
                if (fieldStr.includes(',') || fieldStr.includes('\n') || fieldStr.includes('"')) {
                    return '"' + fieldStr.replace(/"/g, '""') + '"';
                }
                return fieldStr;
            }).join(',')
        ).join('\n');
        
        // 添加BOM以支援中文
        const bom = '\uFEFF';
        const csvWithBom = bom + csvContent;
        
        // 創建下載
        const blob = new Blob([csvWithBom], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // 生成檔案名稱（包含當前日期時間）
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:.]/g, '-');
            link.setAttribute('download', `測試案例匯出_${timestamp}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert(`成功匯出 ${allTestCases.length} 個測試案例`, 'success');
        } else {
            throw new Error('瀏覽器不支援檔案下載');
        }
        
    } catch (error) {
        console.error('匯出失敗:', error);
        showAlert('匯出失敗: ' + error.message, 'danger');
    }
}

// 顯示警告訊息
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // 3秒後自動移除
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}
</script>
{% endblock %}