{% extends "base.html" %}

{% block title %}測試案例管理 - API Monitor{% endblock %}
{% block page_title %}測試案例管理{% endblock %}
{% block page_subtitle %}管理和追蹤產品測試案例{% endblock %}

{% block extra_css %}
.editable-table {
    font-size: 14px;
}
.editable-cell {
    min-height: 40px;
    border: 1px solid transparent;
    cursor: text;
}
.editable-cell:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}
.editable-cell:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}
.acceptance-criteria {
    max-width: 300px;
}
.acceptance-criteria ul {
    margin: 0;
    padding-left: 20px;
}
.product-tags {
    max-width: 200px;
}
.tag-badge {
    display: inline-block;
    margin: 2px;
    padding: 2px 8px;
    background-color: #007bff;
    color: white;
    border-radius: 12px;
    font-size: 11px;
}
.tag-input {
    border: none;
    background: transparent;
    width: 100%;
}
.actions-toolbar {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}
.table-container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}
.table-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
}
.table-title {
    margin: 0;
}
.btn-group .btn {
    margin-right: 10px;
}
.btn-group .btn:last-child {
    margin-right: 0;
}
{% endblock %}

{% block content %}
<!-- 工具列 -->
<div class="actions-toolbar">
    <div class="d-flex flex-wrap align-items-center justify-content-between">
        <div class="btn-group" role="group">
            <button class="btn btn-success" onclick="createNewTestCase()">
                <i class="fas fa-plus"></i> 新增測試案例
            </button>
            <button class="btn btn-info" onclick="batchEdit()">
                <i class="fas fa-edit"></i> 批量編輯
            </button>
            <button class="btn btn-warning" onclick="exportData()">
                <i class="fas fa-download"></i> 匯出資料
            </button>
        </div>
        
        <div class="d-flex align-items-center">
            <input type="text" class="form-control me-2" placeholder="搜尋測試案例..." 
                   id="searchInput" style="width: 200px;">
            <button class="btn btn-outline-primary" onclick="searchTestCases()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</div>

<!-- 測試案例表格 -->
<div class="table-container">
    <div class="table-header">
        <h2 class="table-title"><i class="fas fa-list-check"></i> 測試案例列表</h2>
    </div>
    
    <div class="table-responsive">
        <table class="table editable-table mb-0">
            <thead class="table-light">
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="form-check-input" id="selectAll">
                    </th>
                    <th style="width: 150px;">產品標籤</th>
                    <th style="width: 200px;">標題</th>
                    <th style="width: 120px;">用戶角色</th>
                    <th style="width: 250px;">功能描述</th>
                    <th style="width: 200px;">目的</th>
                    <th style="width: 300px;">驗收條件</th>
                    <th style="width: 100px;">測試結果</th>
                    <th style="width: 200px;">測試備註</th>
                    <th style="width: 120px;">創建者</th>
                    <th style="width: 120px;">更新時間</th>
                    <th style="width: 100px;">操作</th>
                </tr>
            </thead>
            <tbody id="testCasesTableBody">
                <!-- 測試案例資料將通過 JavaScript 載入 -->
            </tbody>
        </table>
    </div>
</div>

<!-- 載入中提示 -->
<div id="loadingIndicator" class="text-center py-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-2">載入測試案例中...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全域變數
let testCases = [];
let productTags = [];
let isEditMode = false;
let selectedCases = new Set();

// 頁面載入完成時初始化
document.addEventListener('DOMContentLoaded', function() {
    loadTestCases();
    loadProductTags();
    setupEventListeners();
});

// 載入測試案例
async function loadTestCases() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const tableBody = document.getElementById('testCasesTableBody');
    
    try {
        loadingIndicator.style.display = 'block';
        
        const response = await fetch('/api/test-cases');
        if (!response.ok) throw new Error('載入失敗');
        
        testCases = await response.json();
        renderTestCases();
        
    } catch (error) {
        console.error('載入測試案例失敗:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="12" class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle"></i> 載入測試案例失敗
                </td>
            </tr>
        `;
    } finally {
        loadingIndicator.style.display = 'none';
    }
}

// 載入產品標籤
async function loadProductTags() {
    try {
        const response = await fetch('/api/product-tags');
        if (response.ok) {
            productTags = await response.json();
        }
    } catch (error) {
        console.error('載入產品標籤失敗:', error);
    }
}

// 渲染測試案例表格
function renderTestCases() {
    const tableBody = document.getElementById('testCasesTableBody');
    
    if (testCases.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="12" class="text-center py-4 text-muted">
                    <i class="fas fa-inbox fa-2x mb-3"></i>
                    <br>尚無測試案例
                    <br><small>點擊「新增測試案例」開始建立</small>
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = testCases.map(testCase => `
        <tr data-id="${testCase.id}">
            <td>
                <input type="checkbox" class="form-check-input case-checkbox" 
                       value="${testCase.id}" onchange="toggleCaseSelection('${testCase.id}')">
            </td>
            <td class="product-tags">
                <div class="tag-container" onclick="editProductTags('${testCase.id}')">
                    ${(testCase.product_tags || []).map(tag => 
                        `<span class="tag-badge">${tag}</span>`
                    ).join('')}
                    <input type="text" class="tag-input" style="display: none;" 
                           onblur="saveProductTags('${testCase.id}')" 
                           onkeypress="handleTagKeypress(event, '${testCase.id}')"
                           value="${(testCase.product_tags || []).join(', ')}">
                </div>
            </td>
            <td class="editable-cell" onclick="editCell(this, '${testCase.id}', 'title')"
                data-original="${testCase.title}">${testCase.title}</td>
            <td class="editable-cell" onclick="editCell(this, '${testCase.id}', 'user_role')"
                data-original="${testCase.user_role}">${testCase.user_role}</td>
            <td class="editable-cell" onclick="editCell(this, '${testCase.id}', 'feature_description')"
                data-original="${testCase.feature_description}">${testCase.feature_description}</td>
            <td class="editable-cell" onclick="editCell(this, '${testCase.id}', 'purpose')"
                data-original="${testCase.purpose}">${testCase.purpose}</td>
            <td class="acceptance-criteria">
                <ul>
                    ${(testCase.acceptance_criteria || []).map(criteria => `<li>${criteria}</li>`).join('')}
                </ul>
                <button class="btn btn-sm btn-outline-primary mt-1" 
                        onclick="editAcceptanceCriteria('${testCase.id}')">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
            <td>
                <select class="form-select form-select-sm" 
                        onchange="updateTestResult('${testCase.id}', this.value)">
                    <option value="Pending" ${testCase.test_result === 'Pending' ? 'selected' : ''}>待測試</option>
                    <option value="Passed" ${testCase.test_result === 'Passed' ? 'selected' : ''}>通過</option>
                    <option value="Failed" ${testCase.test_result === 'Failed' ? 'selected' : ''}>失敗</option>
                    <option value="Blocked" ${testCase.test_result === 'Blocked' ? 'selected' : ''}>阻塞</option>
                </select>
            </td>
            <td class="editable-cell" onclick="editCell(this, '${testCase.id}', 'test_notes')"
                data-original="${testCase.test_notes || ''}">${testCase.test_notes || ''}</td>
            <td><small>${testCase.created_by || 'Unknown'}</small></td>
            <td><small>${formatDate(testCase.updated_at)}</small></td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteTestCase('${testCase.id}')" title="刪除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// 設置事件監聽器
function setupEventListeners() {
    // 全選功能
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.case-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = this.checked;
            toggleCaseSelection(cb.value);
        });
    });
    
    // 搜尋功能
    document.getElementById('searchInput').addEventListener('input', debounce(searchTestCases, 300));
}

// 其他功能函數（簡化版，實際功能需要更完整的實現）
function createNewTestCase() {
    // 實現新增測試案例邏輯
    alert('新增測試案例功能');
}

function batchEdit() {
    if (selectedCases.size === 0) {
        alert('請先選擇要編輯的測試案例');
        return;
    }
    // 實現批量編輯邏輯
    alert(`批量編輯 ${selectedCases.size} 個測試案例`);
}

function exportData() {
    // 實現匯出邏輯
    alert('匯出資料功能');
}

function searchTestCases() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (!searchTerm.trim()) {
        renderTestCases();
        return;
    }
    
    const filteredCases = testCases.filter(tc => 
        tc.title.toLowerCase().includes(searchTerm) ||
        tc.feature_description.toLowerCase().includes(searchTerm) ||
        tc.user_role.toLowerCase().includes(searchTerm)
    );
    
    // 暫時更新顯示
    const originalTestCases = testCases;
    testCases = filteredCases;
    renderTestCases();
    testCases = originalTestCases;
}

function toggleCaseSelection(caseId) {
    if (selectedCases.has(caseId)) {
        selectedCases.delete(caseId);
    } else {
        selectedCases.add(caseId);
    }
}

function formatDate(dateString) {
    if (!dateString) return '未知';
    return new Date(dateString).toLocaleString('zh-TW');
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 其他編輯功能（需要完整實現）
function editCell(cell, caseId, field) {
    // 實現單元格編輯
    console.log('編輯:', caseId, field);
}

function editProductTags(caseId) {
    // 實現產品標籤編輯
    console.log('編輯產品標籤:', caseId);
}

function editAcceptanceCriteria(caseId) {
    // 實現驗收條件編輯
    console.log('編輯驗收條件:', caseId);
}

function updateTestResult(caseId, result) {
    // 實現測試結果更新
    console.log('更新測試結果:', caseId, result);
}

function deleteTestCase(caseId) {
    if (confirm('確定要刪除這個測試案例嗎？')) {
        // 實現刪除邏輯
        console.log('刪除測試案例:', caseId);
    }
}
</script>
{% endblock %}