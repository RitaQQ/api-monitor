{% extends "base.html" %}

{% block title %}測試專案管理 - API Monitor{% endblock %}
{% block page_title %}測試專案管理{% endblock %}
{% block page_subtitle %}管理和追蹤測試專案進度{% endblock %}

{% block extra_css %}
.project-card {
    transition: transform 0.2s, box-shadow 0.2s;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.project-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.project-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px 10px 0 0;
}

.project-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    padding: 20px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-number {
    font-size: 1.5em;
    font-weight: bold;
    color: #667eea;
}

.stat-label {
    font-size: 0.9em;
    color: #6c757d;
    margin-top: 5px;
}

.create-project-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-size: 1.5em;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 100;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-icon {
    font-size: 4em;
    margin-bottom: 20px;
    color: #dee2e6;
}
{% endblock %}

{% block content %}
<!-- 專案概覽 -->
<div class="row" id="projectsContainer">
    <!-- 專案卡片將通過 JavaScript 載入 -->
</div>

<!-- 載入中提示 -->
<div id="loadingIndicator" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-3">載入專案資料中...</p>
</div>

<!-- 空狀態 -->
<div id="emptyState" class="empty-state" style="display: none;">
    <div class="empty-icon">
        <i class="fas fa-folder-open"></i>
    </div>
    <h4>尚無測試專案</h4>
    <p>點擊右下角的按鈕建立您的第一個測試專案</p>
</div>

<!-- 新增專案按鈕 -->
<button class="create-project-btn" onclick="showCreateProjectModal()" title="新增專案">
    <i class="fas fa-plus"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
// 頁面載入完成時初始化
document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
});

// 載入專案資料
async function loadProjects() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const projectsContainer = document.getElementById('projectsContainer');
    const emptyState = document.getElementById('emptyState');
    
    try {
        loadingIndicator.style.display = 'block';
        emptyState.style.display = 'none';
        
        const response = await fetch('/api/test-projects');
        if (!response.ok) throw new Error('載入失敗');
        
        const projects = await response.json();
        
        if (projects.length === 0) {
            emptyState.style.display = 'block';
            projectsContainer.innerHTML = '';
        } else {
            renderProjects(projects);
        }
        
    } catch (error) {
        console.error('載入專案失敗:', error);
        projectsContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> 載入專案資料失敗
                </div>
            </div>
        `;
    } finally {
        loadingIndicator.style.display = 'none';
    }
}

// 渲染專案卡片
function renderProjects(projects) {
    const projectsContainer = document.getElementById('projectsContainer');
    
    projectsContainer.innerHTML = projects.map(project => `
        <div class="col-lg-6 col-xl-4">
            <div class="project-card">
                <div class="project-header">
                    <h5 class="mb-0">${project.name}</h5>
                    <small>建立時間: ${formatDate(project.created_at)}</small>
                </div>
                
                <div class="project-stats">
                    <div class="stat-item">
                        <div class="stat-number">${project.test_cases_count || 0}</div>
                        <div class="stat-label">測試案例</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${project.passed_count || 0}</div>
                        <div class="stat-label">通過</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${project.failed_count || 0}</div>
                        <div class="stat-label">失敗</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${project.pending_count || 0}</div>
                        <div class="stat-label">待測試</div>
                    </div>
                </div>
                
                <div class="p-3 border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            建立者: ${project.created_by || 'Unknown'}
                        </small>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="viewProject('${project.id}')" title="檢視">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteProject('${project.id}', '${project.name}')" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// 格式化日期
function formatDate(dateString) {
    if (!dateString) return '未知';
    return new Date(dateString).toLocaleDateString('zh-TW');
}

// 功能函數
function showCreateProjectModal() {
    alert('新增專案功能（需要實現）');
}

function viewProject(projectId) {
    // 跳轉到專案詳情頁面
    window.location.href = `/test-projects/${projectId}`;
}

function deleteProject(projectId, projectName) {
    if (confirm(`確定要刪除專案「${projectName}」嗎？這將刪除所有相關的測試案例。`)) {
        // 實現刪除邏輯
        console.log('刪除專案:', projectId);
        // 這裡應該調用 API 刪除專案
    }
}
</script>
{% endblock %}