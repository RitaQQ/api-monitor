<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試專案管理 - API Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .project-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8em;
        }
        .progress-ring {
            width: 80px;
            height: 80px;
        }
        .wizard-step {
            padding: 20px;
            min-height: 400px;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step-indicator .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            position: relative;
        }
        .step-indicator .step.active {
            background-color: #007bff;
            color: white;
        }
        .step-indicator .step.completed {
            background-color: #28a745;
            color: white;
        }
        .step-indicator .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 20px;
            height: 2px;
            background-color: #e9ecef;
            transform: translateY(-50%);
        }
        .step-indicator .step:last-child::after {
            display: none;
        }
        .test-case-selector {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 15px;
        }
        .test-case-item {
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .test-case-item:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .test-case-item.selected {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        .test-result-item {
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 15px;
            margin-bottom: 15px;
        }
        .result-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .stats-card {
            text-align: center;
            padding: 20px;
            border-radius: 0.5rem;
            color: white;
        }
        .stats-card.pass { background: linear-gradient(135deg, #28a745, #20c997); }
        .stats-card.fail { background: linear-gradient(135deg, #dc3545, #fd7e14); }
        .stats-card.pending { background: linear-gradient(135deg, #6c757d, #adb5bd); }
        .stats-card.total { background: linear-gradient(135deg, #007bff, #6610f2); }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center py-3">
                    <h2><i class="fas fa-project-diagram"></i> 測試專案管理</h2>
                    <div>
                        <a href="/test-case-management" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-clipboard-list"></i> 測試案例
                        </a>
                        <a href="/" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-arrow-left"></i> 返回首頁
                        </a>
                        <button class="btn btn-primary" id="createProject">
                            <i class="fas fa-plus"></i> 建立新專案
                        </button>
                    </div>
                </div>

                <!-- 專案列表 -->
                <div class="row" id="projectsList">
                    <!-- 動態載入專案卡片 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 專案建立精靈 Modal -->
    <div class="modal fade" id="projectWizardModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">建立測試專案</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 步驟指示器 -->
                    <div class="step-indicator">
                        <div class="step active" data-step="1">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="step" data-step="2">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="step" data-step="3">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>

                    <!-- 步驟 1: 基本資訊 -->
                    <div class="wizard-step" id="step1">
                        <h4>基本資訊</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="projectName" class="form-label">專案名稱 *</label>
                                    <input type="text" class="form-control" id="projectName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="testDate" class="form-label">測試日期 *</label>
                                    <input type="date" class="form-control" id="testDate" required>
                                </div>
                                <div class="mb-3">
                                    <label for="responsibleUser" class="form-label">負責人 *</label>
                                    <select class="form-select" id="responsibleUser" required>
                                        <!-- 動態載入用戶列表 -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">專案說明</h6>
                                        <p class="card-text text-muted">
                                            請填寫基本的專案資訊。完成後，您將選擇要測試的案例，
                                            並可以在專案執行過程中記錄測試結果。
                                        </p>
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb"></i>
                                                建議專案名稱包含版本號或測試範圍，例如：「v1.2 功能測試」
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 步驟 2: 選擇測試案例 -->
                    <div class="wizard-step d-none" id="step2">
                        <h4>選擇測試案例</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">篩選條件</label>
                                    <input type="text" class="form-control mb-2" id="caseSearch" placeholder="搜尋案例...">
                                    <select class="form-select mb-2" id="tagFilter">
                                        <option value="">所有產品標籤</option>
                                    </select>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary" id="selectAll">全選</button>
                                        <button class="btn btn-sm btn-outline-secondary" id="clearAll">清除</button>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-body">
                                        <h6>已選擇</h6>
                                        <span class="badge bg-primary" id="selectedCount">0</span> 個測試案例
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="test-case-selector" id="testCaseSelector">
                                    <!-- 動態載入測試案例 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 步驟 3: 確認建立 -->
                    <div class="wizard-step d-none" id="step3">
                        <h4>確認建立</h4>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 id="confirmProjectName"></h5>
                                        <p class="text-muted">
                                            <i class="fas fa-calendar"></i> 測試日期：<span id="confirmTestDate"></span><br>
                                            <i class="fas fa-user"></i> 負責人：<span id="confirmResponsibleUser"></span><br>
                                            <i class="fas fa-tasks"></i> 測試案例：<span id="confirmTestCaseCount"></span> 個
                                        </p>
                                        
                                        <h6>選擇的測試案例</h6>
                                        <div id="confirmTestCases" class="mt-2">
                                            <!-- 動態載入確認列表 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                                        <h6>準備建立專案</h6>
                                        <p class="text-muted small">
                                            確認資訊無誤後，點擊「建立專案」按鈕。
                                            專案建立後，您可以開始執行測試並記錄結果。
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-outline-primary d-none" id="prevStep">上一步</button>
                    <button type="button" class="btn btn-primary" id="nextStep">下一步</button>
                    <button type="button" class="btn btn-success d-none" id="createProjectBtn">建立專案</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 專案詳情 Modal -->
    <div class="modal fade" id="projectDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="projectDetailTitle"></h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" id="exportPdfBtn">
                            <i class="fas fa-file-pdf"></i> 匯出PDF
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- 專案資訊 -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>測試日期：</strong> <span id="detailTestDate"></span></p>
                                            <p><strong>負責人：</strong> <span id="detailResponsibleUser"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>專案狀態：</strong> <span id="detailStatus"></span></p>
                                            <p><strong>建立時間：</strong> <span id="detailCreatedAt"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="row">
                                <div class="col-6">
                                    <div class="stats-card total">
                                        <div class="h4 mb-0" id="statTotal">0</div>
                                        <small>總測項</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stats-card pass">
                                        <div class="h4 mb-0" id="statPass">0</div>
                                        <small>通過</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <div class="stats-card fail">
                                        <div class="h4 mb-0" id="statFail">0</div>
                                        <small>失敗</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stats-card pending">
                                        <div class="h4 mb-0" id="statPending">0</div>
                                        <small>待測</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 測試結果 -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">測試結果</h6>
                        </div>
                        <div class="card-body">
                            <div id="testResultsList">
                                <!-- 動態載入測試結果 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class TestProjectManager {
            constructor() {
                this.projects = [];
                this.testCases = [];
                this.productTags = [];
                this.users = [];
                this.selectedTestCases = new Set();
                this.currentStep = 1;
                this.currentProject = null;
                
                this.init();
            }
            
            async init() {
                await this.loadData();
                this.bindEvents();
                this.renderProjects();
                this.populateUserSelect();
            }
            
            async loadData() {
                try {
                    const [projectsResponse, testCasesResponse, tagsResponse, usersResponse] = await Promise.all([
                        fetch('/api/test-projects'),
                        fetch('/api/test-cases'),
                        fetch('/api/product-tags'),
                        fetch('/api/users')
                    ]);
                    
                    this.projects = await projectsResponse.json();
                    this.testCases = await testCasesResponse.json();
                    this.productTags = await tagsResponse.json();
                    this.users = await usersResponse.json();
                } catch (error) {
                    console.error('載入資料失敗:', error);
                }
            }
            
            bindEvents() {
                // 建立新專案
                document.getElementById('createProject').addEventListener('click', () => {
                    this.showProjectWizard();
                });
                
                // 精靈導航
                document.getElementById('nextStep').addEventListener('click', () => {
                    this.nextStep();
                });
                
                document.getElementById('prevStep').addEventListener('click', () => {
                    this.prevStep();
                });
                
                document.getElementById('createProjectBtn').addEventListener('click', () => {
                    this.createProject();
                });
                
                // 測試案例選擇
                document.getElementById('selectAll').addEventListener('click', () => {
                    this.selectAllTestCases();
                });
                
                document.getElementById('clearAll').addEventListener('click', () => {
                    this.clearAllTestCases();
                });
                
                document.getElementById('caseSearch').addEventListener('input', () => {
                    this.filterTestCases();
                });
                
                document.getElementById('tagFilter').addEventListener('change', () => {
                    this.filterTestCases();
                });
                
                // PDF 匯出
                document.getElementById('exportPdfBtn').addEventListener('click', () => {
                    this.exportProjectPdf();
                });
            }
            
            renderProjects() {
                const container = document.getElementById('projectsList');
                container.innerHTML = '';
                
                if (this.projects.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">尚無測試專案</h5>
                                <p class="text-muted">點擊「建立新專案」開始您的第一個測試專案</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                this.projects.forEach(project => {
                    const card = this.createProjectCard(project);
                    container.appendChild(card);
                });
            }
            
            createProjectCard(project) {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 mb-4';
                
                const statistics = this.calculateProjectStatistics(project);
                const statusColor = this.getStatusColor(project.status);
                const statusText = this.getStatusText(project.status);
                
                col.innerHTML = `
                    <div class="card project-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title">${project.name}</h5>
                                <span class="badge bg-${statusColor} status-badge">${statusText}</span>
                            </div>
                            
                            <div class="row text-center mb-3">
                                <div class="col-3">
                                    <div class="text-primary h6 mb-0">${statistics.total}</div>
                                    <small class="text-muted">總測項</small>
                                </div>
                                <div class="col-3">
                                    <div class="text-success h6 mb-0">${statistics.passed}</div>
                                    <small class="text-muted">通過</small>
                                </div>
                                <div class="col-3">
                                    <div class="text-danger h6 mb-0">${statistics.failed}</div>
                                    <small class="text-muted">失敗</small>
                                </div>
                                <div class="col-3">
                                    <div class="text-secondary h6 mb-0">${statistics.pending}</div>
                                    <small class="text-muted">待測</small>
                                </div>
                            </div>
                            
                            <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: ${statistics.passRate}%"></div>
                                <div class="progress-bar bg-danger" style="width: ${statistics.failRate}%"></div>
                            </div>
                            
                            <div class="text-muted small mb-3">
                                <i class="fas fa-calendar"></i> ${new Date(project.test_date).toLocaleDateString('zh-TW')}
                                <br><i class="fas fa-user"></i> ${project.responsible_user}
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm flex-fill view-project" data-id="${project.id}">
                                    <i class="fas fa-eye"></i> 查看詳情
                                </button>
                                <button class="btn btn-outline-secondary btn-sm edit-project" data-id="${project.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm delete-project" data-id="${project.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 綁定事件
                col.querySelector('.view-project').addEventListener('click', (e) => {
                    this.viewProject(e.target.dataset.id);
                });
                
                col.querySelector('.delete-project').addEventListener('click', (e) => {
                    this.deleteProject(e.target.dataset.id);
                });
                
                return col;
            }
            
            calculateProjectStatistics(project) {
                const total = project.selected_test_cases.length;
                const results = project.test_results || {};
                
                let passed = 0, failed = 0;
                
                for (const result of Object.values(results)) {
                    if (result.status === 'pass') passed++;
                    else if (result.status === 'fail') failed++;
                }
                
                const pending = total - passed - failed;
                const passRate = total > 0 ? (passed / total * 100) : 0;
                const failRate = total > 0 ? (failed / total * 100) : 0;
                
                return {
                    total,
                    passed,
                    failed,
                    pending,
                    passRate: Math.round(passRate),
                    failRate: Math.round(failRate)
                };
            }
            
            getStatusColor(status) {
                const colors = {
                    'draft': 'secondary',
                    'in_progress': 'warning',
                    'completed': 'success'
                };
                return colors[status] || 'secondary';
            }
            
            getStatusText(status) {
                const texts = {
                    'draft': '草稿',
                    'in_progress': '進行中',
                    'completed': '已完成'
                };
                return texts[status] || '未知';
            }
            
            showProjectWizard() {
                this.currentStep = 1;
                this.selectedTestCases.clear();
                
                // 重置表單
                document.getElementById('projectName').value = '';
                document.getElementById('testDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('responsibleUser').value = '';
                
                this.updateWizardStep();
                this.renderTestCaseSelector();
                this.renderTagFilter();
                
                new bootstrap.Modal(document.getElementById('projectWizardModal')).show();
            }
            
            nextStep() {
                if (this.currentStep === 1) {
                    if (!this.validateStep1()) return;
                    this.currentStep = 2;
                } else if (this.currentStep === 2) {
                    if (!this.validateStep2()) return;
                    this.renderConfirmation();
                    this.currentStep = 3;
                }
                
                this.updateWizardStep();
            }
            
            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateWizardStep();
                }
            }
            
            updateWizardStep() {
                // 更新步驟指示器
                document.querySelectorAll('.step').forEach((step, index) => {
                    const stepNum = index + 1;
                    step.classList.remove('active', 'completed');
                    
                    if (stepNum < this.currentStep) {
                        step.classList.add('completed');
                    } else if (stepNum === this.currentStep) {
                        step.classList.add('active');
                    }
                });
                
                // 顯示/隱藏步驟內容
                document.querySelectorAll('.wizard-step').forEach((step, index) => {
                    step.classList.toggle('d-none', index + 1 !== this.currentStep);
                });
                
                // 更新按鈕
                document.getElementById('prevStep').classList.toggle('d-none', this.currentStep === 1);
                document.getElementById('nextStep').classList.toggle('d-none', this.currentStep === 3);
                document.getElementById('createProjectBtn').classList.toggle('d-none', this.currentStep !== 3);
                
                if (this.currentStep === 3) {
                    document.getElementById('nextStep').classList.add('d-none');
                } else {
                    document.getElementById('nextStep').textContent = this.currentStep === 2 ? '下一步' : '下一步';
                }
            }
            
            validateStep1() {
                const name = document.getElementById('projectName').value.trim();
                const date = document.getElementById('testDate').value;
                const user = document.getElementById('responsibleUser').value;
                
                if (!name || !date || !user) {
                    alert('請填寫所有必填欄位');
                    return false;
                }
                
                return true;
            }
            
            validateStep2() {
                if (this.selectedTestCases.size === 0) {
                    alert('請至少選擇一個測試案例');
                    return false;
                }
                
                return true;
            }
            
            populateUserSelect() {
                const select = document.getElementById('responsibleUser');
                select.innerHTML = '<option value="">請選擇負責人</option>' + 
                    this.users.map(user => `<option value="${user.username}">${user.username}</option>`).join('');
            }
            
            renderTagFilter() {
                const select = document.getElementById('tagFilter');
                select.innerHTML = '<option value="">所有產品標籤</option>' + 
                    this.productTags.map(tag => `<option value="${tag.id}">${tag.name}</option>`).join('');
            }
            
            renderTestCaseSelector() {
                const container = document.getElementById('testCaseSelector');
                container.innerHTML = '';
                
                this.testCases.forEach(testCase => {
                    const item = this.createTestCaseItem(testCase);
                    container.appendChild(item);
                });
                
                this.updateSelectedCount();
            }
            
            createTestCaseItem(testCase) {
                const div = document.createElement('div');
                div.className = 'test-case-item';
                div.dataset.id = testCase.id;
                
                const tags = testCase.product_tags.map(tagId => {
                    const tag = this.productTags.find(t => t.id === tagId);
                    return `<span class="badge bg-secondary me-1">${tag ? tag.name : '未知'}</span>`;
                }).join('');
                
                div.innerHTML = `
                    <div class="d-flex align-items-start">
                        <input type="checkbox" class="form-check-input me-2 mt-1" data-id="${testCase.id}">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${testCase.title}</h6>
                            <p class="text-muted small mb-1">${testCase.user_role} - ${testCase.feature_description}</p>
                            <div>${tags}</div>
                        </div>
                    </div>
                `;
                
                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = div.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        this.toggleTestCaseSelection(testCase.id, checkbox.checked);
                    }
                });
                
                div.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                    this.toggleTestCaseSelection(testCase.id, e.target.checked);
                });
                
                return div;
            }
            
            toggleTestCaseSelection(testCaseId, selected) {
                const item = document.querySelector(`[data-id="${testCaseId}"]`);
                
                if (selected) {
                    this.selectedTestCases.add(testCaseId);
                    item.classList.add('selected');
                } else {
                    this.selectedTestCases.delete(testCaseId);
                    item.classList.remove('selected');
                }
                
                this.updateSelectedCount();
            }
            
            updateSelectedCount() {
                document.getElementById('selectedCount').textContent = this.selectedTestCases.size;
            }
            
            selectAllTestCases() {
                document.querySelectorAll('#testCaseSelector input[type="checkbox"]:not(:checked)').forEach(checkbox => {
                    checkbox.checked = true;
                    this.toggleTestCaseSelection(checkbox.dataset.id, true);
                });
            }
            
            clearAllTestCases() {
                document.querySelectorAll('#testCaseSelector input[type="checkbox"]:checked').forEach(checkbox => {
                    checkbox.checked = false;
                    this.toggleTestCaseSelection(checkbox.dataset.id, false);
                });
            }
            
            filterTestCases() {
                const search = document.getElementById('caseSearch').value.toLowerCase();
                const tagFilter = document.getElementById('tagFilter').value;
                
                document.querySelectorAll('.test-case-item').forEach(item => {
                    const testCaseId = item.dataset.id;
                    const testCase = this.testCases.find(tc => tc.id === testCaseId);
                    
                    if (!testCase) return;
                    
                    let visible = true;
                    
                    // 文字搜尋
                    if (search) {
                        const text = (testCase.title + ' ' + testCase.user_role + ' ' + testCase.feature_description).toLowerCase();
                        if (!text.includes(search)) {
                            visible = false;
                        }
                    }
                    
                    // 標籤篩選
                    if (visible && tagFilter) {
                        if (!testCase.product_tags.includes(tagFilter)) {
                            visible = false;
                        }
                    }
                    
                    item.style.display = visible ? 'block' : 'none';
                });
            }
            
            renderConfirmation() {
                document.getElementById('confirmProjectName').textContent = document.getElementById('projectName').value;
                document.getElementById('confirmTestDate').textContent = document.getElementById('testDate').value;
                document.getElementById('confirmResponsibleUser').textContent = document.getElementById('responsibleUser').value;
                document.getElementById('confirmTestCaseCount').textContent = this.selectedTestCases.size;
                
                const container = document.getElementById('confirmTestCases');
                const selectedCases = this.testCases.filter(tc => this.selectedTestCases.has(tc.id));
                
                container.innerHTML = selectedCases.map(testCase => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <strong>${testCase.title}</strong>
                            <div class="text-muted small">${testCase.user_role}</div>
                        </div>
                        <div>
                            ${testCase.product_tags.map(tagId => {
                                const tag = this.productTags.find(t => t.id === tagId);
                                return `<span class="badge bg-secondary">${tag ? tag.name : '未知'}</span>`;
                            }).join(' ')}
                        </div>
                    </div>
                `).join('');
            }
            
            async createProject() {
                const projectData = {
                    name: document.getElementById('projectName').value.trim(),
                    test_date: document.getElementById('testDate').value,
                    responsible_user: document.getElementById('responsibleUser').value,
                    selected_test_cases: Array.from(this.selectedTestCases)
                };
                
                try {
                    const response = await fetch('/api/test-projects', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(projectData)
                    });
                    
                    if (response.ok) {
                        const newProject = await response.json();
                        this.projects.push(newProject);
                        this.renderProjects();
                        
                        bootstrap.Modal.getInstance(document.getElementById('projectWizardModal')).hide();
                        
                        // 顯示成功訊息並打開專案詳情
                        setTimeout(() => {
                            this.viewProject(newProject.id);
                        }, 500);
                    } else {
                        throw new Error('建立專案失敗');
                    }
                } catch (error) {
                    console.error('建立專案失敗:', error);
                    alert('建立專案失敗，請稍後再試');
                }
            }
            
            async viewProject(projectId) {
                const project = this.projects.find(p => p.id === projectId);
                if (!project) return;
                
                this.currentProject = project;
                
                // 填入專案資訊
                document.getElementById('projectDetailTitle').textContent = project.name;
                document.getElementById('detailTestDate').textContent = new Date(project.test_date).toLocaleDateString('zh-TW');
                document.getElementById('detailResponsibleUser').textContent = project.responsible_user;
                document.getElementById('detailStatus').innerHTML = `<span class="badge bg-${this.getStatusColor(project.status)}">${this.getStatusText(project.status)}</span>`;
                document.getElementById('detailCreatedAt').textContent = new Date(project.created_at).toLocaleString('zh-TW');
                
                // 更新統計
                const stats = this.calculateProjectStatistics(project);
                document.getElementById('statTotal').textContent = stats.total;
                document.getElementById('statPass').textContent = stats.passed;
                document.getElementById('statFail').textContent = stats.failed;
                document.getElementById('statPending').textContent = stats.pending;
                
                // 渲染測試結果
                this.renderTestResults(project);
                
                new bootstrap.Modal(document.getElementById('projectDetailModal')).show();
            }
            
            renderTestResults(project) {
                const container = document.getElementById('testResultsList');
                container.innerHTML = '';
                
                project.selected_test_cases.forEach(testCaseId => {
                    const testCase = this.testCases.find(tc => tc.id === testCaseId);
                    const result = project.test_results[testCaseId];
                    
                    if (!testCase) return;
                    
                    const item = this.createTestResultItem(testCase, result, project.id);
                    container.appendChild(item);
                });
            }
            
            createTestResultItem(testCase, result, projectId) {
                const div = document.createElement('div');
                div.className = 'test-result-item';
                
                const status = result ? result.status : 'not_tested';
                const statusColor = {
                    'pass': 'success',
                    'fail': 'danger',
                    'not_tested': 'secondary'
                }[status];
                
                const statusText = {
                    'pass': '通過',
                    'fail': '失敗',
                    'not_tested': '待測試'
                }[status];
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <h6>${testCase.title}</h6>
                            <p class="text-muted small mb-1">${testCase.user_role} - ${testCase.feature_description}</p>
                            ${testCase.acceptance_criteria.length > 0 ? `
                                <div class="small">
                                    <strong>驗收條件：</strong>
                                    <ul class="mb-0">
                                        ${testCase.acceptance_criteria.map(criterion => `<li>${criterion}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        <span class="badge bg-${statusColor}">${statusText}</span>
                    </div>
                    
                    <div class="result-form">
                        <div class="result-buttons">
                            <button class="btn btn-success btn-sm result-btn" data-status="pass" data-case-id="${testCase.id}" data-project-id="${projectId}">
                                <i class="fas fa-check"></i> 通過
                            </button>
                            <button class="btn btn-danger btn-sm result-btn" data-status="fail" data-case-id="${testCase.id}" data-project-id="${projectId}">
                                <i class="fas fa-times"></i> 失敗
                            </button>
                            <button class="btn btn-secondary btn-sm result-btn" data-status="not_tested" data-case-id="${testCase.id}" data-project-id="${projectId}">
                                <i class="fas fa-undo"></i> 重置
                            </button>
                        </div>
                        
                        <div class="mt-2">
                            <textarea class="form-control form-control-sm mb-2" placeholder="測試備註..." data-field="notes">${result ? (result.notes || '') : ''}</textarea>
                            <textarea class="form-control form-control-sm" placeholder="已知問題..." data-field="known_issues">${result ? (result.known_issues || '') : ''}</textarea>
                        </div>
                    </div>
                `;
                
                // 綁定結果按鈕事件
                div.querySelectorAll('.result-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const status = e.target.dataset.status;
                        const caseId = e.target.dataset.caseId;
                        const projectId = e.target.dataset.projectId;
                        const notes = div.querySelector('[data-field="notes"]').value;
                        const knownIssues = div.querySelector('[data-field="known_issues"]').value;
                        
                        this.updateTestResult(projectId, caseId, status, notes, knownIssues);
                    });
                });
                
                // 綁定文字區域事件（自動儲存）
                div.querySelectorAll('textarea').forEach(textarea => {
                    let saveTimeout;
                    textarea.addEventListener('input', () => {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(() => {
                            const caseId = testCase.id;
                            const currentResult = this.currentProject.test_results[caseId];
                            const currentStatus = currentResult ? currentResult.status : 'not_tested';
                            const notes = div.querySelector('[data-field="notes"]').value;
                            const knownIssues = div.querySelector('[data-field="known_issues"]').value;
                            
                            this.updateTestResult(projectId, caseId, currentStatus, notes, knownIssues);
                        }, 1000);
                    });
                });
                
                return div;
            }
            
            async updateTestResult(projectId, testCaseId, status, notes, knownIssues) {
                try {
                    const response = await fetch(`/api/test-projects/${projectId}/results`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            test_case_id: testCaseId,
                            status: status,
                            notes: notes,
                            known_issues: knownIssues
                        })
                    });
                    
                    if (response.ok) {
                        const updatedProject = await response.json();
                        
                        // 更新本地資料
                        const projectIndex = this.projects.findIndex(p => p.id === projectId);
                        if (projectIndex !== -1) {
                            this.projects[projectIndex] = updatedProject;
                            this.currentProject = updatedProject;
                        }
                        
                        // 更新統計顯示
                        const stats = this.calculateProjectStatistics(updatedProject);
                        document.getElementById('statTotal').textContent = stats.total;
                        document.getElementById('statPass').textContent = stats.passed;
                        document.getElementById('statFail').textContent = stats.failed;
                        document.getElementById('statPending').textContent = stats.pending;
                        
                        // 更新專案列表中的卡片
                        this.renderProjects();
                        
                        // 更新狀態徽章
                        const resultItem = document.querySelector(`[data-case-id="${testCaseId}"]`).closest('.test-result-item');
                        const badge = resultItem.querySelector('.badge');
                        const statusColor = {
                            'pass': 'success',
                            'fail': 'danger',
                            'not_tested': 'secondary'
                        }[status];
                        
                        const statusText = {
                            'pass': '通過',
                            'fail': '失敗',
                            'not_tested': '待測試'
                        }[status];
                        
                        badge.className = `badge bg-${statusColor}`;
                        badge.textContent = statusText;
                        
                    } else {
                        throw new Error('更新測試結果失敗');
                    }
                } catch (error) {
                    console.error('更新測試結果失敗:', error);
                    alert('更新測試結果失敗，請稍後再試');
                }
            }
            
            async deleteProject(projectId) {
                if (!confirm('確定要刪除這個測試專案嗎？此操作無法復原。')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/test-projects/${projectId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.projects = this.projects.filter(p => p.id !== projectId);
                        this.renderProjects();
                    } else {
                        throw new Error('刪除專案失敗');
                    }
                } catch (error) {
                    console.error('刪除專案失敗:', error);
                    alert('刪除專案失敗，請稍後再試');
                }
            }
            
            async exportProjectPdf() {
                if (!this.currentProject) return;
                
                try {
                    const response = await fetch(`/api/test-projects/${this.currentProject.id}/export-pdf`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `${this.currentProject.name}_測試報告.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        throw new Error('匯出PDF失敗');
                    }
                } catch (error) {
                    console.error('匯出PDF失敗:', error);
                    alert('匯出PDF失敗，請稍後再試');
                }
            }
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            new TestProjectManager();
        });
    </script>
</body>
</html>